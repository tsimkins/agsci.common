<?xml version="1.0" encoding="utf-8"?>
<rules xmlns="http://namespaces.plone.org/diazo"
       xmlns:css="http://namespaces.plone.org/diazo/css"
       xmlns:xhtml="http://www.w3.org/1999/xhtml"
       xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
       xmlns:xi="http://www.w3.org/2001/XInclude">

    <!-- Include barceloneta's backend.xml for backend theming. -->
    <rules css:if-content=".userrole-authenticated">

        <xi:include href="backend.xml"><xi:fallback /></xi:include>

        <!-- 
            Also update these in:
             *  agsci.common.browser.viewlets.CSSViewlet.edit_permissions
             *  agsci.common.theme.assets.css._base.css
         -->

        <rules css:if-content="
            body.viewpermission-manage-portal,
            body.viewpermission-add-portal-content,
            body.viewpermission-manage-schemata,
            body.viewpermission-modify-portal-content, 
            body.viewpermission-portlets-manage-portlets, 
            body.viewpermission-list-folder-contents,
            body.viewpermission-plone-site-setup-editing,
            body.viewpermission-plone-site-setup-filtering,
            body.viewpermission-plone-site-setup-imaging,
            body.viewpermission-plone-site-setup-language,
            body.viewpermission-plone-site-setup-mail,
            body.viewpermission-plone-site-setup-markup,
            body.viewpermission-plone-site-setup-navigation,
            body.viewpermission-plone-site-setup-overview,
            body.viewpermission-plone-site-setup-search,
            body.viewpermission-plone-site-setup-security,
            body.viewpermission-plone-site-setup-site,
            body.viewpermission-plone-site-setup-themes,
            body.viewpermission-plone-site-setup-tinymce,
            body.viewpermission-plone-site-setup-types,
            body.viewpermission-plone-site-setup-users-and-groups">
            <drop css:theme="header, footer" />
            <drop css:theme="#theme-javascript" />
            <drop css:theme="a.back-to-top" />
            <drop css:theme="[data-component='portlets']" />

        </rules>

        <rules css:if-content="body.viewpermission-portlets-manage-portlets">

            <append css:theme="#manage-portlets #column-one">
                <h2>Left Column Portlets</h2>
            </append>
            
            <append css:theme="#manage-portlets #column-two">
                <h2>Right Column Portlets</h2>
            </append>
            
            <append css:theme="#manage-portlets #column-one" css:content-children="#portal-column-one" />
            <append css:theme="#manage-portlets #column-two" css:content-children="#portal-column-two" />
        </rules>

        <drop css:content="#audience-nav-viewlet" />
        <drop css:content="#primary-nav-viewlet" />

    </rules>

    <!-- Drop portlet manager div -->
    <rules css:if-not-content="body.viewpermission-portlets-manage-portlets">
        <drop css:theme="#manage-portlets" />
    </rules>

    <rules css:if-content="body[class]">

        <theme href="theme.html" />

        <notheme css:if-not-content="#visual-portal-wrapper" />

        <!-- Don't theme in Mosaic editor. -->
        <notheme css:if-content="textarea.pat-layout" />
        <notheme css:if-not-content="body[class]" />

        <rules css:if-content="#portal-top, #content-header">
            <!-- Attributes -->
            <copy attributes="*" css:theme="html" css:content="html" />

            <!-- Base tag -->
            <before css:theme="title" css:content="base" />

            <!-- Title -->
            <replace css:theme="title" css:content="title" />

            <!-- Pull in Plone Meta -->
            <after css:theme-children="head" css:content="head meta" />

            <!-- Don't use Plone icons, use the theme's -->
            <drop css:content="head link[rel='apple-touch-icon']" />
            <drop css:content="head link[rel='shortcut icon']" />

            <!-- CSS -->
            <after css:theme-children="head" css:content="head link" />
            <after css:theme-children="head" css:content="head style" />

        </rules>

<!-- pasteme -->

        <rules css:if-content=".template-facetednavigation_view">
            <after css:theme-children="#theme-javascript" css:content="head script" />
        </rules>

        <!-- Copy over the id/class attributes on the body tag. This is important for per-section styling -->
        <append attributes="*" css:content="body" css:theme="body" />
    
        <!-- move global nav -->
        <replace css:theme-children="#mainnavigation" css:content-children="#portal-mainnavigation" method="raw" />
    
        <!-- full-width breadcrumb -->
        <replace css:content="#viewlet-above-content" css:theme="#above-content" />
    
        <!-- Navigation -->
        <replace css:content-children="#logo-viewlet" css:theme="#logo-viewlet" />
        
        <replace css:content-children="#audience-nav-viewlet" css:theme="#audience-nav-viewlet" />
        <replace css:content-children="#primary-nav-viewlet" css:theme="#primary-nav-viewlet" />

        <replace css:content-children="aside.portletNavigationTree" css:theme-children="#navbarSectionNav" />
        
        <!-- 
            If we have a nav portlet, drop the first child in column one. 
            This is an assumption based on convention.
        -->
        <rules css-if-content="#portal-column-one aside.portletNavigationTree">
            <drop css:content="#portal-column-one .portletWrapper:first-child" />
        </rules>

        <!-- Portlets -->

        <replace css:content-children="#portal-column-one" 
                css:theme="#portal-column-one" />

        <replace css:content-children="#portal-column-two" 
                css:theme="#portal-column-two" />

        <rules css:if-not-content="#portal-column-one">
            <drop css:theme="#portal-column-one" />
        </rules>

        <rules css:if-not-content="#portal-column-two">
            <drop css:theme="#portal-column-two" />
        </rules>

        <rules css:if-not-content="#portal-column-one, #portal-column-two">
            <drop css:theme="[data-component='portlets']" />
        </rules>
        
        <!-- Central column -->

        <rules css:if-content="body.mosaic-grid">
            <replace css:theme="#content" css:content-children="#content" />
        </rules>

        <rules css:if-not-content="body.mosaic-grid">
            <replace css:theme="#content-container" method="raw">
    
                <xsl:variable name="central">
    
                    <xsl:if test="//aside[@id='portal-column-one'] or //aside[@id='portal-column-two']">col-lg-8 </xsl:if>
                    <xsl:if test="not(//aside[@id='portal-column-one']) and not(//aside[@id='portal-column-two'])">col-lg-12</xsl:if>
                    
                </xsl:variable>
            
                <div class="{$central} col-12 px-0 mt-3 px-lg-3 pb-4 documentText order-12 order-lg-1">
                    <div class="row">
                    <div class="container">
                        <xsl:apply-templates css:select="#content" />
                    </div>
                    </div>
                </div>
    
            </replace>
        </rules>

        <!-- Alert message -->
        <replace css:theme-children="#global_statusmessage" css:content-children="#global_statusmessage" />
    
        <!-- Left column -->
        <rules css:if-content="#portal-column-one">
        <replace css:theme="#column1-container">
            <div class="col-xs-6 col-sm-3 sidebar-offcanvas">
            <aside id="portal-column-one">
                <xsl:copy-of css:select="#portal-column-one > *" />
            </aside>
            </div>
        </replace>
        </rules>
    
        <!-- Right column -->
        <rules css:if-content="#portal-column-two">
        <replace css:theme="#column2-container">
            <div class="col-xs-6 col-sm-3 sidebar-offcanvas" role="complementary">
            <aside id="portal-column-two">
                <xsl:copy-of css:select="#portal-column-two > *" />
            </aside>
            </div>
        </replace>
        </rules>
    
        <!-- Content header -->
        <replace css:theme="#portal-top" css:content-children="#portal-top" />
    
        <!-- Footer -->
        <replace css:theme-children="#portal-footer" css:content-children="#portal-footer-wrapper" />

        <replace css:theme="#footer-contact" css:content-children="#footer-contact" />
        <replace css:theme="#footer-social" css:content-children="#footer-social" />
        <replace css:theme="#footer-links" css:content-children="#footer-links" />

    </rules>

</rules>
